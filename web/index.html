<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SM.MS</title>
  <link href="/assets/main.css" rel="stylesheet">
  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      location.href = '/config.html';
    }
  </script>
</head>

<body class="flex items-center justify-center flex-col">
  <div class="mx-auto w-1/2 h-80 flex items-center justify-center">
    <label id="upload-container"
      class="flex w-full cursor-pointer appearance-none items-center justify-center rounded-md border-2 border-dashed border-gray-200 p-6 transition-all hover:border-primary-300 h-full">
      <div class="space-y-1 text-center">
        <div class="mx-auto inline-flex h-10 w-10 items-center justify-center rounded-full bg-gray-100">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor" class="h-6 w-6 text-gray-500">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
          </svg>
        </div>
        <div class="text-gray-600"><a href="#" class="font-medium text-primary-500 hover:text-primary-700">Click to
            upload</a> or drag and drop</div>
      </div>
      <input id="file-uploader" type="file" class="sr-only" accept="image/*" />
    </label>

    <svg id="loading" class="hidden" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
      style="margin: auto;" width="200px" height="200px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
      <g>
        <circle cx="60" cy="50" r="4" fill="#4b9bbe">
          <animate attributeName="cx" repeatCount="indefinite" dur="1s" values="95;35" keyTimes="0;1" begin="-0.67s">
          </animate>
          <animate attributeName="fill-opacity" repeatCount="indefinite" dur="1s" values="0;1;1" keyTimes="0;0.2;1"
            begin="-0.67s"></animate>
        </circle>
        <circle cx="60" cy="50" r="4" fill="#4b9bbe">
          <animate attributeName="cx" repeatCount="indefinite" dur="1s" values="95;35" keyTimes="0;1" begin="-0.33s">
          </animate>
          <animate attributeName="fill-opacity" repeatCount="indefinite" dur="1s" values="0;1;1" keyTimes="0;0.2;1"
            begin="-0.33s"></animate>
        </circle>
        <circle cx="60" cy="50" r="4" fill="#4b9bbe">
          <animate attributeName="cx" repeatCount="indefinite" dur="1s" values="95;35" keyTimes="0;1" begin="0s">
          </animate>
          <animate attributeName="fill-opacity" repeatCount="indefinite" dur="1s" values="0;1;1" keyTimes="0;0.2;1"
            begin="0s"></animate>
        </circle>
      </g>
      <g transform="translate(-15 0)">
        <path d="M50 50L20 50A30 30 0 0 0 80 50Z" fill="#3e6d8d" transform="rotate(90 50 50)"></path>
        <path d="M50 50L20 50A30 30 0 0 0 80 50Z" fill="#3e6d8d">
          <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s"
            values="0 50 50;45 50 50;0 50 50" keyTimes="0;0.5;1"></animateTransform>
        </path>
        <path d="M50 50L20 50A30 30 0 0 1 80 50Z" fill="#3e6d8d">
          <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s"
            values="0 50 50;-45 50 50;0 50 50" keyTimes="0;0.5;1"></animateTransform>
        </path>
      </g>
    </svg>
  </div>
  <div class="mx-auto w-1/2 mt-4 ">
    <div>
      <div id="upload-result-content" class="relative z-0 flex invisible">
        <input type="url" id="image_url"
          class="block w-full rounded-md rounded-r-none border-gray-300 shadow-sm focus:z-10 focus:border-primary-400 focus:ring focus:ring-primary-200 focus:ring-opacity-50 disabled:cursor-not-allowed disabled:bg-gray-50 disabled:text-gray-500" />
        <button id="copy-btn"
          class="flex items-center space-x-1 rounded-md rounded-l-none border border-l-0 border-gray-300 px-2.5 text-gray-700 hover:bg-gray-100">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor" class="h-4 w-4">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.057 1.123-.08M15.75 18H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08M15.75 18.75v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5A3.375 3.375 0 006.375 7.5H5.25m11.9-3.664A2.251 2.251 0 0015 2.25h-1.5a2.251 2.251 0 00-2.15 1.586m5.8 0c.065.21.1.433.1.664v.75h-6V4.5c0-.231.035-.454.1-.664M6.75 7.5H4.875c-.621 0-1.125.504-1.125 1.125v12c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V16.5a9 9 0 00-9-9z" />
          </svg>
          <span>Copy</span>
        </button>
      </div>
    </div>
  </div>


  <script defer>
    const fileUploader = document.getElementById('file-uploader');
    const uploadResultContent = document.getElementById('upload-result-content');

    function loading(isLoading) {
      const loading = document.getElementById('loading');
      const uploadContainer = document.getElementById('upload-container');
      if (isLoading) {
        loading.classList.remove('hidden');
        uploadContainer.classList.add('hidden');
      } else {
        loading.classList.add('hidden');
        uploadContainer.classList.remove('hidden');
      }
    }

    function uploadImage(file) {
      var data = new FormData()
      data.append('smfile', file)
      loading(true);
      fetch('/api/upload', {
        headers: {
          Authorization: token,
        },
        method: 'POST',
        body: data
      }).then(res => res.json()).then(res => {
        loading(false);
        if (res.code === 'success') {
          uploadResultContent.classList.remove('invisible');
          document.getElementById('image_url').value = res.data.url;
        } else {
          uploadResultContent.classList.remove('invisible');
          if (res.error) {
            document.getElementById('image_url').value = res.error;
          } else {

            document.getElementById('image_url').value = res.images;
          }
        }
        document.getElementById('copy-btn').addEventListener('click', () => {
          document.getElementById('image_url').select();
          document.execCommand('copy');
        })
      })
    }

    var oDragWrap = document.body;

    //拖进
    oDragWrap.addEventListener(
      "dragenter",
      function (e) {
        e.preventDefault();
      },
      false
    );

    oDragWrap.addEventListener(
      "dragover",
      function (e) {
        e.preventDefault();
      },
      false
    );

    //扔
    oDragWrap.addEventListener(
      "drop",
      function (e) {
        dropHandler(e);
      },
      false
    );
    document.addEventListener("paste", () => {
      const items = (event.clipboardData || event.originalEvent.clipboardData)
        .items;
      for (const item of items) {
        if (item.kind === "file") {
          const blob = item.getAsFile();
          uploadImage(blob);
        }
      }
    }, false);

    var dropHandler = function (e) {
      e.preventDefault(); //获取文件列表
      var fileList = e.dataTransfer.files;
      //检测是否是拖拽文件到页面的操作
      if (fileList.length == 0) {
        return;
      }
      //检测文件是不是图片
      if (fileList[0].type.indexOf("image") === -1) {
        return;
      }
      uploadImage(fileList[0]);

    };
    fileUploader.addEventListener('change', (event) => {
      const files = event.target.files;
      uploadImage(files[0]);
    });
  </script>
</body>

</html>
